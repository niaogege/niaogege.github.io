<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>vue进阶5-virtual Dom | Niaogege</title><meta name="description" content="virtual Dom 是什么虚拟 DOM 其实就是js对象，通过对象的方式表示真实的 DOM 结构，将页面的状态抽象成js对象的形式 为什么需要虚拟dom频繁的操作 DOM 会使得网站的性能下降，为了保证性能，我们需要使得 DOM 的操作尽量精简，我们可以通过操作虚拟 DOM 的方法，去比较新旧节点的差异然后精确的获取最小的，最为必要的 DOM 集合，最终挂载到真实的 DOM 上。因为操作数据结"><meta name="keywords" content="虚拟dom,virtualDom, vNode, diff"><meta name="author" content="chendapeng,291003932@qq.com"><meta name="copyright" content="chendapeng"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://niaogege.cn/2021/04/03/vue%E8%BF%9B%E9%98%B65-virtual-Dom/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="vue进阶5-virtual Dom"><meta property="og:url" content="http://niaogege.cn/2021/04/03/vue%E8%BF%9B%E9%98%B65-virtual-Dom/"><meta property="og:site_name" content="Niaogege"><meta property="og:description" content="virtual Dom 是什么虚拟 DOM 其实就是js对象，通过对象的方式表示真实的 DOM 结构，将页面的状态抽象成js对象的形式 为什么需要虚拟dom频繁的操作 DOM 会使得网站的性能下降，为了保证性能，我们需要使得 DOM 的操作尽量精简，我们可以通过操作虚拟 DOM 的方法，去比较新旧节点的差异然后精确的获取最小的，最为必要的 DOM 集合，最终挂载到真实的 DOM 上。因为操作数据结"><meta property="og:image" content="http://niaogege.cn/images/vue_sty_2.jpg"><meta property="article:published_time" content="2021-04-03T10:33:23.000Z"><meta property="article:modified_time" content="2021-05-03T05:27:47.593Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="vue进阶6-diff算法" href="http://niaogege.cn/2021/04/03/vue%E8%BF%9B%E9%98%B66-diff%E7%AE%97%E6%B3%95/"><link rel="next" title="vue进阶4-watch和computed" href="http://niaogege.cn/2021/04/03/vue%E8%BF%9B%E9%98%B64-watch%E5%92%8Ccomputed/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: {"languages":{"author":"作者: chendapeng","link":"链接: ","source":"来源: Niaogege","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">78</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">82</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">97</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li><li><a class="site-page" href="/phots/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> Messageboard</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#virtual-Dom-是什么"><span class="toc-number">1.</span> <span class="toc-text">virtual Dom 是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么需要虚拟dom"><span class="toc-number">2.</span> <span class="toc-text">为什么需要虚拟dom</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#虚拟dom优缺点"><span class="toc-number">3.</span> <span class="toc-text">虚拟dom优缺点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#virtual-dom-实现"><span class="toc-number">4.</span> <span class="toc-text">virtual dom 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#用js对象模拟DOM树"><span class="toc-number">4.1.</span> <span class="toc-text">用js对象模拟DOM树</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#render方法生成真实-DOM-节点"><span class="toc-number">4.2.</span> <span class="toc-text">render方法生成真实 DOM 节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#比较新老虚拟dom差异-即diff算法"><span class="toc-number">4.3.</span> <span class="toc-text">比较新老虚拟dom差异-即diff算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#深度优先遍历-记录俩棵树的差异"><span class="toc-number">4.3.1.</span> <span class="toc-text">深度优先遍历 记录俩棵树的差异</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#根据差异更改原先真实的dom结构-即更新dom"><span class="toc-number">4.3.2.</span> <span class="toc-text">根据差异更改原先真实的dom结构,即更新dom</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dom-diff过程"><span class="toc-number">4.4.</span> <span class="toc-text">dom diff过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vue的虚拟dom"><span class="toc-number">5.</span> <span class="toc-text">vue的虚拟dom</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#模板转换成视图的过程"><span class="toc-number">5.1.</span> <span class="toc-text">模板转换成视图的过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vue模板编译原理"><span class="toc-number">5.2.</span> <span class="toc-text">Vue模板编译原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#parse"><span class="toc-number">5.2.1.</span> <span class="toc-text">parse</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#optimize"><span class="toc-number">5.2.2.</span> <span class="toc-text">optimize</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#generate"><span class="toc-number">5.2.3.</span> <span class="toc-text">generate</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VNode模拟virtual-dom结构"><span class="toc-number">5.3.</span> <span class="toc-text">VNode模拟virtual-dom结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#VNode类解析"><span class="toc-number">5.3.1.</span> <span class="toc-text">VNode类解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#源码创建-VNode-过程"><span class="toc-number">5.3.2.</span> <span class="toc-text">源码创建 VNode 过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vue对Dom更新做了哪些标记优化处理"><span class="toc-number">6.</span> <span class="toc-text">vue对Dom更新做了哪些标记优化处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">7.</span> <span class="toc-text">参考</span></a></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/images/vue_sty_2.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Niaogege</a></span><span class="pull-right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li><li><a class="site-page" href="/phots/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> Messageboard</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">vue进阶5-virtual Dom</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2021-04-03 18:33:23"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2021-04-03</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-05-03 13:27:47"><i class="fas fa-history fa-fw"></i> 更新于 2021-05-03</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/vue/">vue</a><i class="fas fa-angle-right post-meta__separator"></i><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/vue/vNode/">vNode</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta__icon"></i><span>字数总计:</span><span class="word-count">4.3k</span><span class="post-meta__separator">|</span><i class="far fa-clock fa-fw post-meta__icon"></i><span>阅读时长: 17 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="far fa-comments fa-fw post-meta__icon"></i><span>评论数:</span><a href="/2021/04/03/vue%E8%BF%9B%E9%98%B65-virtual-Dom/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2021/04/03/vue%E8%BF%9B%E9%98%B65-virtual-Dom/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="virtual-Dom-是什么"><a href="#virtual-Dom-是什么" class="headerlink" title="virtual Dom 是什么"></a>virtual Dom 是什么</h2><p>虚拟 DOM 其实就是js对象，通过对象的方式表示真实的 DOM 结构，将页面的状态抽象成js对象的形式</p>
<h2 id="为什么需要虚拟dom"><a href="#为什么需要虚拟dom" class="headerlink" title="为什么需要虚拟dom"></a>为什么需要虚拟dom</h2><p>频繁的操作 DOM 会使得网站的性能下降，为了保证性能，我们需要使得 DOM 的操作尽量精简，我们可以通过操作虚拟 DOM 的方法，去比较新旧节点的差异然后精确的获取最小的，最为必要的 DOM 集合，最终挂载到真实的 DOM 上。因为操作数据结构，远比我们直接修改 DOM 节点来的快，我们真实的 DOM 操作在最好的情况下，其实只需要在最后来那么一下，他们喊是patch补丁一下</p>
<ul>
<li>保证各框架性能下限，在不进行手动优化的情况下，提供系统过得去的性能</li>
<li>跨平台，例如服务端渲染(这个能力的根本，是 Javascript 代码能<strong>低代价</strong>地在各个平台运行（得利于浏览器在各个平台的普及和 NodeJS），也就是常说的 Javascript 的优势之一是跨平台)</li>
</ul>
<h2 id="虚拟dom优缺点"><a href="#虚拟dom优缺点" class="headerlink" title="虚拟dom优缺点"></a>虚拟dom优缺点</h2><ul>
<li>优点是其抽象能力和常驻内存的特性，让vue/react框架能更容易实现更强大的 diff 算法(由于 Virtual DOM 的存在，diff 算法可以更方便且更强大)</li>
<li>缺点是增加了框架复杂度，也占用了更多的内存</li>
</ul>
<p>(本想说一下几个优势，后来发现有大佬觉得这不是虚拟dom的优势)</p>
<p><a href="https://mp.weixin.qq.com/s/nwnnlMLdC-LvnY3-CiiT6A" target="_blank" rel="noopener">大佬总结的几个关于 Virtual DOM 优势误区：</a></p>
<ul>
<li><p>操作 DOM 太慢，操作 Virtual DOM 对象快 ❌<br>Virtual DOM 很快，但这并不是它的优势，因你本可以选择不使用 Virtual DOM 。</p>
</li>
<li><p>使用 Virtual DOM 可以避免频繁操作 DOM ，能有效减少回流和重绘次数 ❌<br>无论你在一次事件循环中调用多少次的 DOM API ，浏览器也只会触发一次回流与重绘（如果需要），并且如果多次调用并没有修改 DOM 状态，那么回流与重绘一次都不会发生。批量操作也不能减少回流与重绘。</p>
</li>
<li><p>Virtual DOM 有跨平台优势 ❌<br>跨平台是 Javascript 的优势，与 Virtual DOM 无关。</p>
</li>
</ul>
<h2 id="virtual-dom-实现"><a href="#virtual-dom-实现" class="headerlink" title="virtual dom 实现"></a>virtual dom 实现</h2><p>主要是这四个步骤，基本上大差不差</p>
<ul>
<li>用js对象模拟DOM树</li>
<li>render方法生成真实 DOM 节点</li>
<li>计算新老虚拟dom差异-即diff算法</li>
<li>将两个虚拟 DOM 对象的差异应用到真正的 DOM 树 </li>
</ul>
<h3 id="用js对象模拟DOM树"><a href="#用js对象模拟DOM树" class="headerlink" title="用js对象模拟DOM树"></a>用js对象模拟DOM树</h3><ul>
<li>tagName 对应真实的标签类型，比如ul标签p标签等等</li>
<li>attrs 表示节点上的所有属性，比如<code>arrts: {class: &#39;list&#39;, style: &quot;color:green&quot;}</code></li>
<li>child 表示该节点的孩子节点, 比如<code>[&#39;Vue&#39;]</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Element</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(tagName, attrs = &#123;&#125;, child = []) &#123;</span><br><span class="line">    <span class="keyword">this</span>.tagName = tagName</span><br><span class="line">    <span class="keyword">this</span>.attrs = attrs</span><br><span class="line">    <span class="keyword">this</span>.child = child</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newElement</span>(<span class="params">tag, attr, child</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Element(tag, attr, child)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 newElement方法即可生成</p>
<h3 id="render方法生成真实-DOM-节点"><a href="#render方法生成真实-DOM-节点" class="headerlink" title="render方法生成真实 DOM 节点"></a>render方法生成真实 DOM 节点</h3><ul>
<li>增加设置对象属性的方法setAttr()</li>
<li>类的内部添加创建真实DOm节点的 render 方法</li>
<li>最后通过一个renderDom方法将dom 渲染到浏览器(appendChild)<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对标签设置属性</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setAttr = <span class="function"><span class="keyword">function</span> (<span class="params">node, key, value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'style'</span>:</span><br><span class="line">      node.style.cssText = <span class="string">`<span class="subst">$&#123;value&#125;</span>`</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'value'</span>:</span><br><span class="line">      <span class="keyword">let</span> tagName = node.tagName || <span class="string">''</span></span><br><span class="line">      tagName = tagName.toLowerCase()</span><br><span class="line">      <span class="keyword">if</span> (tagName === <span class="string">'input'</span> || tagName === <span class="string">'textarea'</span>) &#123;</span><br><span class="line">        node.value = value</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        node.setAttribute(key, value)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      node.setAttribute(key, value)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Element</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(tagName, attrs = &#123;&#125;, child = []) &#123;</span><br><span class="line">    <span class="keyword">this</span>.tagName = tagName</span><br><span class="line">    <span class="keyword">this</span>.attrs = attrs</span><br><span class="line">    <span class="keyword">this</span>.child = child</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">let</span> ele = <span class="built_in">document</span>.createElement(<span class="keyword">this</span>.tagName)</span><br><span class="line">    <span class="keyword">let</span> attrs = <span class="keyword">this</span>.attrs</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> attrs) &#123;</span><br><span class="line">      setAttr(ele, key, attrs[key])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> childNodes = <span class="keyword">this</span>.child</span><br><span class="line">    <span class="comment">// 如果是虚拟dom就继续递归遍历</span></span><br><span class="line">    <span class="comment">// 不是就代表文本节点 直接创建</span></span><br><span class="line">    childNodes.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">child</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> childEle = child <span class="keyword">instanceof</span> Element</span><br><span class="line">        ? child.render()</span><br><span class="line">        : <span class="built_in">document</span>.createTextNode(child)</span><br><span class="line">      <span class="comment">// 挂在到真实的dom节点上</span></span><br><span class="line">      ele.appendChild(childEle)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> ele</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> RealDom = VdObj1.render()</span><br><span class="line"><span class="comment">// console.dir(RealDom)</span></span><br><span class="line"><span class="keyword">const</span> renderDom = <span class="function"><span class="keyword">function</span> (<span class="params">element, target</span>) </span>&#123;</span><br><span class="line">  target.appendChild(element)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  renderDom(RealDom, <span class="built_in">document</span>.body)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="比较新老虚拟dom差异-即diff算法"><a href="#比较新老虚拟dom差异-即diff算法" class="headerlink" title="比较新老虚拟dom差异-即diff算法"></a>比较新老虚拟dom差异-即diff算法</h3><p>diff 算法用来比较两棵 Virtual DOM 树的差异，如果需要两棵树的完全比较，那么 diff 算法的时间复杂度为O(n^3)。但是在前端当中，你很少会跨越层级地移动 DOM 元素，所以 Virtual DOM 只会对同一个层级的元素进行对比，如下图所示， div 只会和同一层级的 div 对比，第二层级的只会跟第二层级对比，这样算法复杂度就可以达到 O(n)</p>
<ul>
<li>深度优先遍历，记录差异</li>
<li>根据差异更改原先真实的dom结构,即更新dom</li>
</ul>
<h4 id="深度优先遍历-记录俩棵树的差异"><a href="#深度优先遍历-记录俩棵树的差异" class="headerlink" title="深度优先遍历 记录俩棵树的差异"></a>深度优先遍历 记录俩棵树的差异</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> diff = <span class="function">(<span class="params">oldNode, newNode</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 用来存放补丁的对象</span></span><br><span class="line">  <span class="keyword">let</span> difference = &#123;&#125;</span><br><span class="line">  <span class="comment">// 递归树 然后把比较后的结果放到补丁里</span></span><br><span class="line">  walk(oldNode, newNode, <span class="number">0</span>, difference)</span><br><span class="line">  <span class="keyword">return</span> difference</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> initIndex = <span class="number">0</span></span><br><span class="line"><span class="keyword">const</span> REMOVE = <span class="string">'remove'</span></span><br><span class="line"><span class="keyword">const</span> MODIFY_TEXT = <span class="string">'modify_text'</span></span><br><span class="line"><span class="keyword">const</span> CHANGE_ATTRS = <span class="string">'change_attrs'</span></span><br><span class="line"><span class="keyword">const</span> TACEREPLACE = <span class="string">'replace'</span></span><br><span class="line"><span class="comment">// 获取最小差异数组</span></span><br><span class="line"><span class="keyword">const</span> walk = <span class="function">(<span class="params">oldNode, newNode, index, difference</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 每个元素都有一个补丁</span></span><br><span class="line">  <span class="keyword">let</span> diffResult = []</span><br><span class="line">  <span class="keyword">if</span> (!newNode) &#123;</span><br><span class="line">    diffResult.push(&#123;</span><br><span class="line">      index,</span><br><span class="line">      type: REMOVE</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 文本节点直接替换</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> newNode === <span class="string">'string'</span> &amp;&amp; <span class="keyword">typeof</span> oldNode === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (oldNode !== newNode) &#123;</span><br><span class="line">      diffResult.push(&#123;</span><br><span class="line">        index,</span><br><span class="line">        value: newNode,</span><br><span class="line">        type: MODIFY_TEXT</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldNode.tagName === newNode.tagNam) &#123;</span><br><span class="line">    <span class="comment">// 节点类型相同 则继续比较熟悉是否相同</span></span><br><span class="line">    <span class="keyword">let</span> storeAttrs = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> oldNode.attrs) &#123;</span><br><span class="line">      <span class="keyword">if</span> (oldNode.attrs[key] !== newNode.attrs[key]) &#123;</span><br><span class="line">        storeAttrs[key] = oldNode.attrs[key]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> newNode.attrs) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!oldNode.attrs.hasOwnProperty(key)) &#123;</span><br><span class="line">        storeAttrs[key] = newNode.attrs[key]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.keys(storeAttrs).length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      diffResult.push(&#123;</span><br><span class="line">        index,</span><br><span class="line">        value: storeAttrs,</span><br><span class="line">        type: CHANGE_ATTRS</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 递归遍历子节点</span></span><br><span class="line">    <span class="keyword">if</span> (oldNode.child &amp;&amp; oldNode.child.length) &#123;</span><br><span class="line">      oldNode.child.forEach(<span class="function">(<span class="params">child, index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 深度递归遍历所有要保留的index</span></span><br><span class="line">        getDiff(child, newNode.child[index], ++initIndex, difference)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldNode.tagName !== newNode.tagName) &#123;</span><br><span class="line">    <span class="comment">// 节点类型不相同 直接替换</span></span><br><span class="line">    diffResult.push(&#123;</span><br><span class="line">      index,</span><br><span class="line">      type: TACEREPLACE,</span><br><span class="line">      newNode</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!oldNode) &#123;</span><br><span class="line">    diffResult.push(&#123;</span><br><span class="line">      newNode,</span><br><span class="line">      type: TACEREPLACE</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 当前元素补丁放到大补丁</span></span><br><span class="line">  <span class="keyword">if</span> (diffResult.length) &#123;</span><br><span class="line">    difference[index] = diffResult</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="根据差异更改原先真实的dom结构-即更新dom"><a href="#根据差异更改原先真实的dom结构-即更新dom" class="headerlink" title="根据差异更改原先真实的dom结构,即更新dom"></a>根据差异更改原先真实的dom结构,即更新dom</h4><p>现在我们已经生成了两个虚拟 DOM, 并且将两个 DOM 之间的差异用对象的方式保存了下来，接下来，我们就要通过这些来将差异更新到真实的 DOM 上面去！！下面的代码很长，但确实是这样的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> patch = <span class="function">(<span class="params">node, difference</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> pacer = &#123; <span class="attr">index</span>: <span class="number">0</span> &#125;</span><br><span class="line">  <span class="comment">// 给元素打补丁</span></span><br><span class="line">  patchNode(node, pacer, difference)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> patchNode = <span class="function">(<span class="params">node, pacer, difference</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> currentDifference = difference[pacer.index]</span><br><span class="line">  <span class="keyword">let</span> childNodes = node.childNodes</span><br><span class="line">  <span class="comment">// 先序深度优先遍历</span></span><br><span class="line">  childNodes.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">    pacer.index++</span><br><span class="line">    patchNode(child, pacer, difference)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">if</span> (currentDifference) &#123;</span><br><span class="line">    doPatch(node, currentDifference)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 根据传递的diff进行遍历操作node节点</span></span><br><span class="line"><span class="keyword">const</span> doPatch = <span class="function">(<span class="params">node, difference</span>) =&gt;</span> &#123;</span><br><span class="line">  difference.forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (item.type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'change_attrs'</span>:</span><br><span class="line">        <span class="keyword">const</span> attrs = item.value</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> attrs) &#123;</span><br><span class="line">          <span class="keyword">if</span> (node.nodeType !== <span class="number">1</span>) <span class="keyword">return</span></span><br><span class="line">          <span class="keyword">const</span> value = attrs[key]</span><br><span class="line">          <span class="keyword">if</span> (value) &#123;</span><br><span class="line">            setAttr(node, key, value)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            node.removeAttribute(key)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">'modify_text'</span>:</span><br><span class="line">        node.textContent = item.value</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">'replace'</span>:</span><br><span class="line">        <span class="comment">// 新节点替换老节点 需要先判断新节点是不是element实例 如果是需要调用render方法渲染新节点</span></span><br><span class="line">        <span class="comment">// 如果不是则表明新节点是文本节点，直接创建一个文本节点</span></span><br><span class="line">        <span class="keyword">let</span> newNode = (item.newNode <span class="keyword">instanceof</span> Element)</span><br><span class="line">          ? item.newNode.render(item.newNode)</span><br><span class="line">          : <span class="built_in">document</span>.createTextNode(item.newNode)</span><br><span class="line">        <span class="comment">// 调用父级的replaceChild方法替换为新的节点</span></span><br><span class="line">        node.parentNode.replaceChild(newNode, node)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">'remove'</span>:</span><br><span class="line">        node.parentNode.removeChild(node)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终调用的时候，这样</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  renderDom(RealDom, <span class="built_in">document</span>.body)</span><br><span class="line">  <span class="keyword">const</span> diffs = diff(VdObj1, VdObj2)</span><br><span class="line">  patch(RealDom, diffs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="dom-diff过程"><a href="#dom-diff过程" class="headerlink" title="dom diff过程"></a>dom diff过程</h3><p>总结来说：</p>
<ul>
<li>用JS对象模拟DOM（虚拟DOM）</li>
<li>把此虚拟DOM转成真实DOM并插入页面中（render）</li>
<li>如果有事件发生修改了虚拟DOM，比较两棵虚拟DOM树的差异，得到差异对象（diff）</li>
<li>把差异对象应用到真正的DOM树上（patch）</li>
</ul>
<h2 id="vue的虚拟dom"><a href="#vue的虚拟dom" class="headerlink" title="vue的虚拟dom"></a>vue的虚拟dom</h2><p>看了这么多别人的关于虚拟dom的文章，今天的主角依然是vue中的虚拟dom和diff算法，不然面试的时候依然直接跪！</p>
<h3 id="模板转换成视图的过程"><a href="#模板转换成视图的过程" class="headerlink" title="模板转换成视图的过程"></a>模板转换成视图的过程</h3><p><img src= "/img/loading.gif" data-src="/images/diff/virtualDom.jpg" alt="vue 虚拟dom"></p>
<ul>
<li>Vue.js通过编译将template 模板转换成渲染函数(render function) ，执行渲染函数就可以得到一个虚拟节点树</li>
<li>在对数据模型进行操作的时候，会触发对应 Dep 中的 Watcher 对象。Watcher 对象会调用对应的 update 来修改视图。这个过程主要是将新旧虚拟节点进行差异对比，然后根据对比结果进行DOM操作来更新视图。</li>
</ul>
<p>针对上图有几个概念说下:</p>
<ul>
<li><p>渲染函数：渲染函数是用来生成Virtual DOM的。Vue推荐使用模板来构建我们的应用界面，在底层实现中Vue会将模板编译成渲染函数，当然我们也可以不写模板，直接写渲染函数，以获得更好的控制。</p>
</li>
<li><p>VNode 虚拟节点：它可以代表一个真实的 dom 节点。通过 <strong>createElement</strong> 方法能将 VNode 渲染成 dom 节点。简单地说，vnode可以理解成节点描述对象，它描述了应该怎样去创建真实的DOM节点。</p>
</li>
<li><p>patch(也叫做patching算法)：虚拟DOM最核心的部分，它可以将vnode渲染成真实的DOM，这个过程是对比新旧虚拟节点之间有哪些不同，然后根据对比结果找出需要更新的的节点进行更新。Vue的Virtual DOM Patching算法是基于Snabbdom的实现，并在此基础上作了很多的调整和改进</p>
</li>
</ul>
<h3 id="Vue模板编译原理"><a href="#Vue模板编译原理" class="headerlink" title="Vue模板编译原理"></a>Vue模板编译原理</h3><p>Vue首先会将template模板进行编译，其中包括parse/optimize/generate三个过程</p>
<h4 id="parse"><a href="#parse" class="headerlink" title="parse"></a>parse</h4><p>parse会使用正则表达式解析template模板中的指令、class/style等数据，形成AST，及上文的这样</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js模拟DOM结构</span></span><br><span class="line"><span class="keyword">var</span> element = &#123;</span><br><span class="line">  tagName: <span class="string">'ul'</span>, <span class="comment">// 节点标签名</span></span><br><span class="line">  attrs: &#123; <span class="comment">// DOM的属性，用一个对象存储键值对</span></span><br><span class="line">    class: 'item',</span><br><span class="line">    id: <span class="string">'list'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  children: [ <span class="comment">// 该节点的子节点</span></span><br><span class="line">    &#123;<span class="attr">tagName</span>: <span class="string">'li'</span>, <span class="attr">attrs</span>: &#123;<span class="attr">class</span>: <span class="string">'item1'</span>&#125;, <span class="attr">children</span>: <span class="string">"Item 1"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">tagName</span>: <span class="string">'li'</span>, <span class="attr">attrs</span>: &#123;<span class="attr">class</span>: <span class="string">'item2'</span>&#125;, <span class="attr">children</span>: <span class="string">"Item 2"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">tagName</span>: <span class="string">'li'</span>, <span class="attr">attrs</span>: &#123;<span class="attr">class</span>: <span class="string">'item3'</span>, <span class="attr">style</span>: <span class="string">'font-size: 20px'</span>&#125;, <span class="attr">children</span>: <span class="string">"Item 3"</span>&#125;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="optimize"><a href="#optimize" class="headerlink" title="optimize"></a>optimize</h4><p>optimize过程主要是为了优化后面的diff算法，vue在编译过程中会主动标记static静态节点，后续update更新视图的时候，patch过程中会直接跳过这些标记静态节点</p>
<h4 id="generate"><a href="#generate" class="headerlink" title="generate"></a>generate</h4><p>最后通过generate 将 AST 转化成 render function 字符串，得到结果是 render 的字符串以及 staticRenderFns 字符串,render函数字符串可能长这样:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">with</span> (<span class="keyword">this</span>) &#123; </span><br><span class="line">    <span class="keyword">return</span> __h__(</span><br><span class="line">      <span class="string">'ul'</span>, </span><br><span class="line">      &#123;<span class="attr">staticClass</span>: <span class="string">"list"</span>&#125;, </span><br><span class="line">      [</span><br><span class="line">        <span class="string">" "</span>,</span><br><span class="line">        __h__(<span class="string">'li'</span>, &#123;<span class="attr">class</span>: item&#125;, [<span class="built_in">String</span>((msg))]),</span><br><span class="line">        <span class="string">" "</span>,</span><br><span class="line">        __h__(<span class="string">'li'</span>, &#123;<span class="attr">class</span>: item&#125;, [<span class="built_in">String</span>((msg))]),</span><br><span class="line">        <span class="string">""</span>,</span><br><span class="line">        __h__(<span class="string">'li'</span>, &#123;<span class="attr">class</span>: item&#125;, [<span class="built_in">String</span>((msg))]),</span><br><span class="line">        <span class="string">""</span></span><br><span class="line">      ]</span><br><span class="line">    )</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="VNode模拟virtual-dom结构"><a href="#VNode模拟virtual-dom结构" class="headerlink" title="VNode模拟virtual-dom结构"></a>VNode模拟virtual-dom结构</h3><p>从虚拟dom到真实DOM要经过vNode定义，diff、patch等过程,总结一下主要的流程</p>
<ul>
<li><p>引入编译时版本vue.esm.js，执行<em>initMixin</em>方法</p>
</li>
<li><p>初始化vue，创建一个Vue实例，执行<strong>this._init</strong>方法，然后执行<strong>vm.$mount(vm.$options.el)</strong>方法准备挂载，生命周期函数<em>callHook(vm, ‘created’)</em>之后</p>
</li>
<li><p>Vue实例挂载，调用<strong>mountComponent方法</strong>，该方法核心就是先实例化一个渲染Watcher，在它的回调函数中会调用 <em>updateComponent</em> 方法，在此方法中调用 <em>vm._render</em> 方法先生成虚拟 VNode，最终调用 <em>vm._update</em> 更新 DOM</p>
</li>
<li><p>创建虚拟VNode,<em>vm._render</em>,会调用<strong>createElement</strong>方法，该方法最终会创建一个VNode实例 <em>new VNode()</em></p>
</li>
</ul>
<h4 id="VNode类解析"><a href="#VNode类解析" class="headerlink" title="VNode类解析"></a>VNode类解析</h4><p>在 Vue.js 中，Virtual DOM 是用 VNode 这个 Class 去描述，它定义在 <code>src/core/vdom/vnode.js</code> 中 ，从以下代码块中可以看到 Vue.js 中的 Virtual DOM 的定义较为复杂一些，因为它这里包含了很多 Vue.js 的特性。实际上 Vue.js 中 Virtual DOM 是借鉴了一个开源库  snabbdom 的实现，然后加入了一些 Vue.js 的一些特性</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> VNode &#123;</span><br><span class="line">  tag: <span class="built_in">string</span> | <span class="built_in">void</span>;</span><br><span class="line">  data: VNodeData | <span class="built_in">void</span>;</span><br><span class="line">  children: ?<span class="built_in">Array</span>&lt;VNode&gt;;</span><br><span class="line">  text: <span class="built_in">string</span> | <span class="built_in">void</span>;</span><br><span class="line">  elm: Node | <span class="built_in">void</span>;</span><br><span class="line">  ns: <span class="built_in">string</span> | <span class="built_in">void</span>;</span><br><span class="line">  context: Component | <span class="built_in">void</span>; <span class="comment">// rendered in this component's scope</span></span><br><span class="line">  key: <span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">void</span>;</span><br><span class="line">  componentOptions: VNodeComponentOptions | <span class="built_in">void</span>;</span><br><span class="line">  componentInstance: Component | <span class="built_in">void</span>; <span class="comment">// component instance</span></span><br><span class="line">  parent: VNode | <span class="built_in">void</span>; <span class="comment">// component placeholder node</span></span><br><span class="line">  <span class="comment">// strictly internal</span></span><br><span class="line">  raw: <span class="built_in">boolean</span>; <span class="comment">// contains raw HTML? (server only)</span></span><br><span class="line">  isStatic: <span class="built_in">boolean</span>; <span class="comment">// hoisted static node</span></span><br><span class="line">  isRootInsert: <span class="built_in">boolean</span>; <span class="comment">// necessary for enter transition check</span></span><br><span class="line">  isComment: <span class="built_in">boolean</span>; <span class="comment">// empty comment placeholder?</span></span><br><span class="line">  isCloned: <span class="built_in">boolean</span>; <span class="comment">// is a cloned node?</span></span><br><span class="line">  isOnce: <span class="built_in">boolean</span>; <span class="comment">// is a v-once node?</span></span><br><span class="line">  asyncFactory: <span class="built_in">Function</span> | <span class="built_in">void</span>; <span class="comment">// async component factory function</span></span><br><span class="line">  asyncMeta: <span class="built_in">Object</span> | <span class="built_in">void</span>;</span><br><span class="line">  isAsyncPlaceholder: <span class="built_in">boolean</span>;</span><br><span class="line">  ssrContext: <span class="built_in">Object</span> | <span class="built_in">void</span>;</span><br><span class="line">  fnContext: Component | <span class="built_in">void</span>; <span class="comment">// real context vm for functional nodes</span></span><br><span class="line">  fnOptions: ?ComponentOptions; <span class="comment">// for SSR caching</span></span><br><span class="line">  devtoolsMeta: ?<span class="built_in">Object</span>; <span class="comment">// used to store functional render context for devtools</span></span><br><span class="line">  fnScopeId: ?<span class="built_in">string</span>; <span class="comment">// functional scope id support</span></span><br><span class="line">  <span class="keyword">constructor</span> (<span class="params"></span></span><br><span class="line"><span class="params">    tag?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">    data?: VNodeData,</span></span><br><span class="line"><span class="params">    children?: ?<span class="built_in">Array</span>&lt;VNode&gt;,</span></span><br><span class="line"><span class="params">    text?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">    elm?: Node,</span></span><br><span class="line"><span class="params">    context?: Component,</span></span><br><span class="line"><span class="params">    componentOptions?: VNodeComponentOptions,</span></span><br><span class="line"><span class="params">    asyncFactory?: <span class="built_in">Function</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.tag = tag</span><br><span class="line">    <span class="keyword">this</span>.data = data</span><br><span class="line">    <span class="keyword">this</span>.children = children</span><br><span class="line">    <span class="keyword">this</span>.text = text</span><br><span class="line">    <span class="keyword">this</span>.elm = elm</span><br><span class="line">    <span class="keyword">this</span>.ns = <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">this</span>.context = context</span><br><span class="line">    <span class="keyword">this</span>.fnContext = <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">this</span>.fnOptions = <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">this</span>.fnScopeId = <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">this</span>.key = data &amp;&amp; data.key</span><br><span class="line">    <span class="keyword">this</span>.componentOptions = componentOptions</span><br><span class="line">    <span class="keyword">this</span>.componentInstance = <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">this</span>.parent = <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">this</span>.raw = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">this</span>.isStatic = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">this</span>.isRootInsert = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">this</span>.isComment = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">this</span>.isCloned = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">this</span>.isOnce = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">this</span>.asyncFactory = asyncFactory</span><br><span class="line">    <span class="keyword">this</span>.asyncMeta = <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">this</span>.isAsyncPlaceholder = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>抓重点，看几个关键的属性定义即可：<br>tag 属性即这个vnode的标签属性,比如h1/span<br>data 属性包含了最后渲染成真实dom节点后，节点上的class，attribute，style以及绑定的事件,比如<code>attrs: {id: &quot;app&quot;, class: &quot;rootApp&quot;}</code><br>children 属性是vnode的子节点<br>text 属性是文本属性<br>elm 属性为这个vnode对应的真实dom节点<br>key 属性是vnode的标记，在<strong>diff</strong>过程中可以提高diff的效率</p>
<h4 id="源码创建-VNode-过程"><a href="#源码创建-VNode-过程" class="headerlink" title="源码创建 VNode 过程"></a>源码创建 VNode 过程</h4><p>1.引入编译时版本vue.esm.js，执行<em>initMixin</em>方法<br>2.初始化vue<br>实例化一个Vue实例时，即<code>new Vue</code>时，执行的src/core/instance/index.js 中定义的 Function 函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    !(<span class="keyword">this</span> <span class="keyword">instanceof</span> Vue)</span><br><span class="line">  ) &#123;</span><br><span class="line">    warn(<span class="string">'Vue is a constructor and should be called with the `new` keyword'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>._init(options)</span><br><span class="line">&#125;</span><br><span class="line">initMixin(Vue)</span><br><span class="line">stateMixin(Vue)</span><br><span class="line">eventsMixin(Vue)</span><br><span class="line">lifecycleMixin(Vue)</span><br><span class="line">renderMixin(Vue)</span><br></pre></td></tr></table></figure>
<p>通过查看 Vue 的 function，我们知道 Vue 只能通过 new 关键字初始化，然后调用 this._init 方法，该方法在 src/core/instance/init.js 中定义。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initMixin</span> (<span class="params">Vue: Class&lt;Component&gt;</span>) </span>&#123;</span><br><span class="line">  Vue.prototype._init = <span class="function"><span class="keyword">function</span> (<span class="params">options?: Object</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> vm: Component = <span class="keyword">this</span></span><br><span class="line">    vm._uid = uid++</span><br><span class="line">    <span class="keyword">let</span> startTag, endTag</span><br><span class="line">    vm.$options = mergeOptions(</span><br><span class="line">      resolveConstructorOptions(vm.constructor),</span><br><span class="line">      options || &#123;&#125;,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">    vm._self = vm</span><br><span class="line">    initLifecycle(vm)</span><br><span class="line">    initEvents(vm)</span><br><span class="line">    initRender(vm)</span><br><span class="line">    callHook(vm, <span class="string">'beforeCreate'</span>)</span><br><span class="line">    initInjections(vm) <span class="comment">// resolve injections before data/props</span></span><br><span class="line">    <span class="comment">// 初始化状态</span></span><br><span class="line">    initState(vm)</span><br><span class="line">    initProvide(vm) <span class="comment">// resolve provide after data/props</span></span><br><span class="line">    callHook(vm, <span class="string">'created'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vm.$options.el) &#123;</span><br><span class="line">      vm.$mount(vm.$options.el)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.Vue实例挂载<br>Vue 中是通过 $mount 实例方法去挂载 dom 的，下面我们通过分析 compiler 版本的 mount 实现，相关源码在目录<code>src/platforms/web/runtime/entry-runtime-with-compiler.js</code> 文件中定义：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.$mount = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el?: string | Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrating?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  el = el &amp;&amp; inBrowser ? query(el) : <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">return</span> mountComponent(<span class="keyword">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们发现$mount 方法实际上会去调用 mountComponent 方法，这个方法定义在 <code>src/core/instance/lifecycle.js</code> 文件中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mountComponent</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  vm: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  el: ?Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrating?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  vm.$el = el</span><br><span class="line">  <span class="comment">// created之后 也就是beforeMount之前已经能拿到$el</span></span><br><span class="line">  callHook(vm, <span class="string">'beforeMount'</span>)</span><br><span class="line">  <span class="keyword">let</span> updateComponent</span><br><span class="line">  updateComponent = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    vm._update(vm._render(), hydrating)</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="comment">// 实例化一个渲染Watcher，在它的回调函数中会调用 updateComponent 方法  </span></span><br><span class="line">  <span class="keyword">new</span> Watcher(vm, updateComponent, noop, &#123;</span><br><span class="line">    before () &#123;</span><br><span class="line">      <span class="keyword">if</span> (vm._isMounted &amp;&amp; !vm._isDestroyed) &#123;</span><br><span class="line">        callHook(vm, <span class="string">'beforeUpdate'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span>)</span><br><span class="line">  hydrating = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// manually mounted instance, call mounted on self</span></span><br><span class="line">  <span class="comment">// mounted is called for render-created child components in its inserted hook</span></span><br><span class="line">  <span class="keyword">if</span> (vm.$vnode == <span class="literal">null</span>) &#123;</span><br><span class="line">    vm._isMounted = <span class="literal">true</span></span><br><span class="line">    callHook(vm, <span class="string">'mounted'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的代码可以看到，mountComponent 核心就是先实例化一个渲染Watcher，在它的回调函数中会调用 <code>updateComponent</code> 方法，在此方法中调用 vm._render 方法先生成虚拟 Node，最终调用 vm._update 更新 DOM。</p>
<p>4.创建虚拟dom<br>紧接上面的<em>vm._render</em>，Vue实例的一个私有方法，它用来把实例渲染成一个虚拟 Node,并返回该虚拟dom。它的定义在 <code>src/core/instance/render.js</code> 文件中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype._render = <span class="function"><span class="keyword">function</span> (<span class="params"></span>): <span class="title">VNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> vm: Component = <span class="keyword">this</span></span><br><span class="line">  <span class="keyword">const</span> &#123; render, _parentVnode &#125; = vm.$options</span><br><span class="line">  vm.$vnode = _parentVnode</span><br><span class="line">  <span class="comment">// render self</span></span><br><span class="line">  <span class="keyword">let</span> vnode</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    currentRenderingInstance = vm</span><br><span class="line">    <span class="comment">// 调用vm.$createElement</span></span><br><span class="line">    vnode = render.call(vm._renderProxy, vm.$createElement)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    handleError(e, vm, <span class="string">`render`</span>)</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; vm.$options.renderError) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        vnode = vm.$options.renderError.call(vm._renderProxy, vm.$createElement, e)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        handleError(e, vm, <span class="string">`renderError`</span>)</span><br><span class="line">        vnode = vm._vnode</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vnode = vm._vnode</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    currentRenderingInstance = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// set parent</span></span><br><span class="line">  vnode.parent = _parentVnode</span><br><span class="line">  <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>vnode = render.call(vm._renderProxy, vm.$createElement)</code>生成虚拟dom,调用<em>createElement</em>方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.$createElement = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> createElement(vm, a, b, c, d, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<p>接着再调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  context: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  data: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  normalizationType: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  alwaysNormalize: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">VNode</span> | <span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> _createElement(context, tag, data, children, normalizationType)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">_createElement</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  context: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag?: string | Class&lt;Component&gt; | Function | Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  data?: VNodeData,</span></span></span><br><span class="line"><span class="function"><span class="params">  children?: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  normalizationType?: number</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">VNode</span> | <span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">   <span class="comment">// 创建虚拟 vnode</span></span><br><span class="line">  vnode = <span class="keyword">new</span> VNode(</span><br><span class="line">    config.parsePlatformTagName(tag), data, children,</span><br><span class="line">    <span class="literal">undefined</span>, <span class="literal">undefined</span>, context</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>createElement 方法有 5 个参数，<br>context 表示 VNode 的上下文环境，它是 Component 类型；<br>tag表示标签，它可以是一个字符串，也可以是一个 Component；<br>data 表示 VNode 的数据，它是一个 VNodeData 类型，可以在 flow/vnode.js 中找到它的定义；<br>children 表示当前 VNode 的子节点，它是任意类型的，需要被规范为标准的 VNode 数组；</p>
<h2 id="vue对Dom更新做了哪些标记优化处理"><a href="#vue对Dom更新做了哪些标记优化处理" class="headerlink" title="vue对Dom更新做了哪些标记优化处理"></a>vue对Dom更新做了哪些标记优化处理</h2><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://mp.weixin.qq.com/s/mIk9skR1wmmXNUdneec-UQ" target="_blank" rel="noopener">分析diff算法与虚拟dom（理解现代前端框架）</a></li>
<li><a href="https://mp.weixin.qq.com/s/oAlVmZ4Hbt2VhOwFEkNEhw" target="_blank" rel="noopener">虚拟 DOM 到底是什么？(长文建议收藏)</a></li>
<li><a href="https://mp.weixin.qq.com/s/nwnnlMLdC-LvnY3-CiiT6A" target="_blank" rel="noopener">Virtual DOM 认知误区</a></li>
<li><a href="https://ustbhuangyi.github.io/vue-analysis/v2/data-driven/virtual-dom.html#%E6%80%BB%E7%BB%93" target="_blank" rel="noopener">Virtual DOM</a></li>
<li><a href="https://juejin.cn/post/6844903615652610055" target="_blank" rel="noopener">深入框架本源系列 —— Virtual Dom</a></li>
<li><a href="https://juejin.cn/post/6854573217462534151" target="_blank" rel="noopener">通俗易懂的vue虚拟（Virtual ）DOM和diff算法</a></li>
<li><a href="https://mp.weixin.qq.com/s/oAlVmZ4Hbt2VhOwFEkNEhw" target="_blank" rel="noopener">虚拟 DOM 到底是什么？(长文建议收藏)</a></li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:291003932@qq.com">chendapeng</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://niaogege.cn/2021/04/03/vue%E8%BF%9B%E9%98%B65-virtual-Dom/">http://niaogege.cn/2021/04/03/vue%E8%BF%9B%E9%98%B65-virtual-Dom/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://niaogege.cn" target="_blank">Niaogege</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/vue/">vue</a><a class="post-meta__tags" href="/tags/vNode/">vNode</a></div><div class="post_share"><div class="social-share" data-image="/images/axios/2.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><button class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/images/wechat.jpg" alt="wechat" onclick="window.open('/images/wechat.jpg')"/><div class="post-qr-code__desc">wechat</div></li><li class="reward-item"><img class="post-qr-code__img" src="/images/alipay.jpg" alt="alipay" onclick="window.open('/images/alipay.jpg')"/><div class="post-qr-code__desc">alipay</div></li></ul></div></button></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/04/03/vue%E8%BF%9B%E9%98%B66-diff%E7%AE%97%E6%B3%95/"><img class="prev-cover" data-src="/images/diff/diff3.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">vue进阶6-diff算法</div></div></a></div><div class="next-post pull-right"><a href="/2021/04/03/vue%E8%BF%9B%E9%98%B64-watch%E5%92%8Ccomputed/"><img class="next-cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">vue进阶4-watch和computed</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/07/18/vue-常用技巧2/" title="vue: 常用技巧2"><img class="relatedPosts_cover" data-src="/images/vue_sty_2.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-18</div><div class="relatedPosts_title">vue: 常用技巧2</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/18/vue-常用技巧1/" title="vue: 常用技巧1"><img class="relatedPosts_cover" data-src="/images/vue_sty_1.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-18</div><div class="relatedPosts_title">vue: 常用技巧1</div></div></a></div><div class="relatedPosts_item"><a href="/2021/04/03/vue进阶1-mvvm/" title="vue进阶1-mvvm"><img class="relatedPosts_cover" data-src="/images/package.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-03</div><div class="relatedPosts_title">vue进阶1-mvvm</div></div></a></div><div class="relatedPosts_item"><a href="/2021/05/04/vue进阶10-keep-alive/" title="vue进阶10-keep-alive"><img class="relatedPosts_cover" data-src="/images/diff/diff3.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-04</div><div class="relatedPosts_title">vue进阶10-keep-alive</div></div></a></div><div class="relatedPosts_item"><a href="/2021/04/03/vue进阶2-lifecycle生命周期/" title="vue进阶2-lifecycle生命周期"><img class="relatedPosts_cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-03</div><div class="relatedPosts_title">vue进阶2-lifecycle生命周期</div></div></a></div><div class="relatedPosts_item"><a href="/2021/04/03/vue进阶3-数据绑定/" title="vue进阶3-数据绑定"><img class="relatedPosts_cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-03</div><div class="relatedPosts_title">vue进阶3-数据绑定</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var requestSetting = function (from,set) {
  var from = from
  var setting = set.split(',').filter(function(item){
  return from.indexOf(item) > -1
  });
  setting = setting.length == 0 ? from :setting;
  return setting
}

var guestInfo = requestSetting(['nick','mail','link'],'nick,mail,link')
var requiredFields = requestSetting(['nick','mail'],'nick,mail')

window.valine = new Valine({
  el:'#vcomment',
  appId: 'oYe5q11f5IaMkDAihtsidxxc-gzGzoHsz',
  appKey: 'bAcvgX39GRkG1blb90XakUSD',
  placeholder: 'Please leave your footprints',
  avatar: 'monsterid',
  meta: guestInfo,
  pageSize: '10',
  lang: 'en',
  recordIP: false,
  serverURLs: '',
  emojiCDN: '',
  emojiMaps: "",
  enableQQ: true,
  requiredFields: requiredFields
});</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2021 By chendapeng</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="http:niaogege.cn">blog</a>!</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button class="translate_chn_to_cht" id="translateLink" title="简繁转换">繁</button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fas fa-comments"></i></a><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="/js/search/local-search.js"></script></body></html>